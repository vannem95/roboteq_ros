#!/usr/bin/env python
import rospy
from std_msgs.msg import Bool
import serial


#########################################################################################
#########################################################################################
######################### Gripper Serial Connection #####################################
#########################################################################################
#########################################################################################

# begin the connection to the roboteq controller
try:

    ser = serial.Serial(
        port='/dev/USB0',
        baudrate=115200, #8N1
        timeout=1,
        parity=serial.PARITY_NONE,
        stopbits=serial.STOPBITS_ONE,
        bytesize=serial.EIGHTBITS,
    )

except:

    raise IOError

# reset the connection if need be
if (ser.isOpen()):
    ser.close()

ser.open()


# activate gripper

ser.write("\x09\x10\x03\xE8\x00\x03\x06\x00\x00\x00\x00\x00\x00\x73\x30")
data_raw = ser.readline()
rospy.sleep(0.01)
ser.write("\x09\x03\x07\xD0\x00\x01\x85\xCF")
data_raw = ser.readline()
rospy.sleep(1)

#########################################################################################
#########################################################################################
############################### Open/close functions ####################################
#########################################################################################
#########################################################################################

#=========================================================================================== 

def open_gripper():

    global ser

    print "Opening gripper..."
    ser.write("\x09\x10\x03\xE8\x00\x03\x06\x09\x00\x00\x00\xFF\xFF\x72\x19")
    data_raw = ser.readline()
    rospy.sleep(2)

def close_gripper():

    global ser

    print "Closing gripper..."
    ser.write("\x09\x10\x03\xE8\x00\x03\x06\x09\x00\x00\xFF\xFF\xFF\x42\x29")
    data_raw = ser.readline()
    rospy.sleep(2)


#########################################################################################



#########################################################################################
#########################################################################################
############################### Callback function #######################################
#########################################################################################
#########################################################################################


def callback(data):

    if data.data == False:
        open_gripper()
    elif data.data == True:
        close_gripper()
    else:
        print "error.."



#########################################################################################



#########################################################################################
#########################################################################################
############################### Initialize function #####################################
#########################################################################################
#########################################################################################

def initialize():
    rospy.init_node('gripper_node', anonymous=True)
    rospy.Subscriber("gripper_joint", Bool, callback)
    rospy.spin()

#########################################################################################

if __name__ == '__main__':
    initialize()
